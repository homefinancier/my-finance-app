<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–î–æ–º–∞—à–Ω–∏–π –§–∏–Ω–∞–Ω—Å–∏—Å—Ç</title>
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --main-bg: #1E2025; --card-bg: #2D3035; --text-color: #F5F0E8; --accent-primary: #D97D54; --accent-secondary: #5A7D7C; --hint-color: #8A8F98; }
        body { font-family: 'Inter', sans-serif; margin: 0; background-color: var(--main-bg); color: var(--text-color); }
        .screen { display: none; padding: 20px; box-sizing: border-box; }
        .screen.active { display: block; }
        h1, h2 { font-family: 'Merriweather', serif; }
        
        #onboarding-screen { height: 100vh; display: flex; flex-direction: column; justify-content: center; text-align: center; }
        #onboarding-screen h1 { font-size: 24px; } #onboarding-screen p { color: var(--hint-color); font-size: 16px; line-height: 1.5; } #onboarding-screen textarea { width: 100%; height: 100px; background-color: var(--card-bg); border: 1px solid #444; border-radius: 8px; color: var(--text-color); font-size: 16px; padding: 10px; box-sizing: border-box; margin-top: 20px; }
        
        #main-screen { padding-bottom: 80px; }
        .welcome-header h1 { font-size: 26px; margin: 0; } .welcome-header p { font-size: 16px; color: var(--hint-color); margin: 4px 0 0 0; } .section-title { font-size: 20px; margin: 30px 0 15px 0; }
        .next-step-card { background-color: var(--card-bg); border-radius: 16px; padding: 20px; cursor: pointer; border: 1px solid var(--accent-primary); } .next-step-card .tag { background-color: var(--accent-primary); color: white; padding: 5px 12px; border-radius: 20px; font-size: 12px; display: inline-block; margin-bottom: 15px; } .next-step-card h2 { font-size: 22px; margin: 0 0 10px 0; }
        .path-container { margin-top: 15px; } .path-item { display: flex; align-items: center; margin-bottom: 10px; } .path-item .icon { width: 24px; height: 24px; border-radius: 50%; background-color: var(--card-bg); color: var(--hint-color); display: flex; align-items: center; justify-content: center; margin-right: 12px; font-weight: bold; } .path-item.completed .icon { background-color: var(--accent-secondary); color: white; } .path-item.completed .title { text-decoration: line-through; color: var(--hint-color); }
        
        .tab-bar { position: fixed; bottom: 0; left: 0; right: 0; height: 60px; background-color: var(--card-bg); border-top: 1px solid #3a3d42; display: flex; justify-content: space-around; padding-top: 5px; padding-bottom: env(safe-area-inset-bottom); }
        .tab-item { display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; color: var(--hint-color); text-decoration: none; flex-grow: 1; } .tab-item.active { color: var(--accent-primary); } .tab-item .icon { font-size: 24px; }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="data.js"></script>
</head>
<body>

    <div id="loading-screen" class="screen active" style="text-align: center;"><h1>–ó–∞–≥—Ä—É–∑–∫–∞...</h1></div>
    <div id="onboarding-screen" class="screen">
        <h1 id="onboarding-title">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h1>
        <p>–ü—Ä–µ–∂–¥–µ —á–µ–º –º—ã –Ω–∞—á–Ω–µ–º, –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å:<br><b>–ö–∞–∫–∏–º –≤—ã —Ö–æ—Ç–∏—Ç–µ –≤–∏–¥–µ—Ç—å —Å–≤–æ–π –æ–±—ã—á–Ω—ã–π –≤—Ç–æ—Ä–Ω–∏–∫ —á–µ—Ä–µ–∑ 10 –ª–µ—Ç?</b></p>
        <textarea id="goal-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∑–¥–µ—Å—å —Å–≤–æ—é —Ü–µ–ª—å..."></textarea>
    </div>
    <div id="main-screen" class="screen">
        <div class="welcome-header"> <h1 id="welcome-title">–í–∞—à –ø—É—Ç—å</h1> <p>–®–∞–≥ –∑–∞ —à–∞–≥–æ–º –∫ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —Å–≤–æ–±–æ–¥–µ</p> </div>
        <h2 class="section-title">–í–∞—à —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥</h2> <div id="next-step-container"></div>
        <h2 class="section-title">–ö–∞—Ä—Ç–∞ –ø—É—Ç–∏</h2> <div id="path-container"></div>
        <nav class="tab-bar">
            <a href="#" class="tab-item active"><span class="icon">üß≠</span><span>–ú–æ–π –ø—É—Ç—å</span></a>
            <a href="#" class="tab-item"><span class="icon">üìö</span><span>–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</span></a>
            <a href="#" class="tab-item"><span class="icon">üîß</span><span>–ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è</span></a>
            <a href="#" class="tab-item"><span class="icon">üîë</span><span>–ü—Ä–æ—Ñ–∏–ª—å</span></a>
        </nav>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        let userData = {}; // –ó–¥–µ—Å—å –±—É–¥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Å–µ—Ä–≤–µ—Ä–∞

        // --- API-–∫–ª–∏–µ–Ω—Ç –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å –±—ç–∫–µ–Ω–¥–æ–º ---
        const api = {
            // –ú–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
            getUserData: async () => {
                const response = await fetch('/api/get_user_data', {
                    headers: { 'Authorization': `tma ${tg.initData}` }
                });
                return response.json();
            },
            // –ú–µ—Ç–æ–¥ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
            saveUserData: async (data) => {
                await fetch('/api/save_user_data', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `tma ${tg.initData}` 
                    },
                    body: JSON.stringify(data)
                });
            }
        };

        // --- –õ–æ–≥–∏–∫–∞ —ç–∫—Ä–∞–Ω–æ–≤ ---
        const screens = { loading: document.getElementById('loading-screen'), onboarding: document.getElementById('onboarding-screen'), main: document.getElementById('main-screen') };
        function showScreen(name) {
            Object.values(screens).forEach(s => s.classList.remove('active'));
            screens[name].classList.add('active');
        }

        // --- –õ–æ–≥–∏–∫–∞ –û–Ω–±–æ—Ä–¥–∏–Ω–≥–∞ ---
        function setupOnboarding() {
            showScreen('onboarding');
            tg.MainButton.setText("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –Ω–∞—á–∞—Ç—å –ø—É—Ç—å").show();
            
            tg.onEvent('mainButtonClicked', async function onGoalSubmit() {
                const goalText = document.getElementById('goal-input').value;
                if (goalText.trim().length > 5) {
                    tg.MainButton.showProgress();
                    await api.saveUserData({ goal: goalText, completedSteps: [] });
                    userData = await api.getUserData();
                    tg.MainButton.hideProgress().hide();
                    tg.offEvent('mainButtonClicked', onGoalSubmit);
                    showMainScreen();
                } else {
                    tg.showAlert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ –≤–∞—à—É —Ü–µ–ª—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ.");
                }
            });
        }
        
        // --- –õ–æ–≥–∏–∫–∞ –ì–ª–∞–≤–Ω–æ–≥–æ –≠–∫—Ä–∞–Ω–∞ ---
        function showMainScreen() {
            showScreen('main');
            renderNextStep();
            renderPath();
        }
        
        function renderNextStep() {
            const nextStep = learningPath.find(step => !userData.completedSteps.includes(step.id));
            if (nextStep) {
                document.getElementById('next-step-container').innerHTML = `
                    <div class="next-step-card" onclick="handleStepClick('${nextStep.id}')">
                        <span class="tag">–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥</span>
                        <h2>${nextStep.title}</h2>
                    </div>`;
            } else { /* ... */ }
        }
        
        function renderPath() {
            const container = document.getElementById('path-container');
            container.innerHTML = '';
            learningPath.forEach((step, index) => {
                const isCompleted = userData.completedSteps.includes(step.id);
                container.innerHTML += `<div class="path-item ${isCompleted ? 'completed' : ''}"><div class="icon">${isCompleted ? '‚úì' : index + 1}</div><div class="title">${step.title}</div></div>`;
            });
        }
        
        async function handleStepClick(stepId) {
            const step = learningPath.find(s => s.id === stepId);
            if (!step) return;

            if (step.type === 'article') {
                tg.openLink(step.url);
                tg.MainButton.setText("–Ø –ø—Ä–æ—á–∏—Ç–∞–ª, –∑–∞—Å—á–∏—Ç–∞—Ç—å —à–∞–≥").show();
                tg.onEvent('mainButtonClicked', async function onStepComplete() {
                    tg.MainButton.showProgress();
                    await completeStep(stepId);
                    tg.MainButton.hideProgress().hide();
                    tg.offEvent('mainButtonClicked', onStepComplete);
                });
            } else if (step.type === 'tool') {
                tg.showAlert(`–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç "${step.title}" –ø–æ–∫–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.`);
                await completeStep(stepId);
            }
        }
        
        async function completeStep(stepId) {
            if (!userData.completedSteps.includes(stepId)) {
                userData.completedSteps.push(stepId);
                await api.saveUserData({ completedSteps: userData.completedSteps });
                renderNextStep();
                renderPath();
            }
        }

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
        async function init() {
            try {
                userData = await api.getUserData();
                if (userData && userData.goal) {
                    showMainScreen();
                } else {
                    setupOnboarding();
                }
            } catch (e) {
                document.getElementById('loading-screen').innerHTML = `<h1>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}</h1>`;
            }
        }
        
        init();
    </script>
</body>
</html>